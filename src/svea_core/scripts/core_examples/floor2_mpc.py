#!/usr/bin/env python
# -*- coding: utf-8 -*-

from __future__ import division
from __future__ import print_function

import rospy
import numpy as np

from svea.states import VehicleState
from svea.localizers import LocalizationInterface
from svea.data import BasicDataHandler, TrajDataHandler, RVIZPathHandler
from svea.models.bicycle import SimpleBicycleModel
from svea.simulators.sim_SVEA import SimSVEA
from sensor_msgs.msg import LaserScan

from svea.svea_managers.mpc_path_following_sveas import SVEAMPC
from svea.controllers.mpc.mpc import MPC

from svea.controllers.mpc.parameters import parameters

"""
__team__ = "Team 1"
__maintainers__ = "Roberto Castro Sundin, Astrid Lindstedt, Johan Hedin, Aravind Sadashiv, Sarthak Manocha‚Äù
__status__ = "Development"
"""


## SIMULATION PARAMS ##########################################################
param_name = "test"
params = parameters.get(param_name)

vehicle_name = ""
target_velocity = params.target_velocity # [m/s]
dt = params.dt # frequency of the model updates

# xs = [-2.33, 10.48]
# ys = [-7.09, 11.71]
# traj_x = np.linspace(xs[0], xs[1]).tolist()
# traj_y = np.linspace(ys[0], ys[1]).tolist()
# xs = [10.48,6.03]
# ys = [11.71,14.8]
# traj_x = np.append(traj_x,np.linspace(xs[0], xs[1]).tolist()[1:])
# traj_y = np.append(traj_y,np.linspace(ys[0], ys[1]).tolist()[1:])
# xs = [6.03,-6.78]
# ys = [14.8,-4]
# traj_x = np.append(traj_x,np.linspace(xs[0], xs[1]).tolist()[1:])
# traj_y = np.append(traj_y,np.linspace(ys[0], ys[1]).tolist()[1:])
# xs = [-6.78,-2.33]
# ys = [-4.00,-7.09]
# traj_x = np.append(traj_x,np.linspace(xs[0], xs[1]).tolist()[1:-1])
# traj_y = np.append(traj_y,np.linspace(ys[0], ys[1]).tolist()[1:-1])

# traj_x =  [0.53502483104700005, 0.75880470850270842, 0.97002287981715085, 1.1827769825984542, 1.3873426959305166, 1.6050772109688944, 1.8277535956462396, 2.0453636707167178, 2.2906895507981102, 2.5267343443202259, 2.7591674842625222, 2.9840820032121989, 3.1980016768456547, 3.4051196721759047, 3.6111423071368787, 3.8284260393523049, 4.051433846863687, 4.2908689735371723, 4.517754642744916, 4.7251538996644751, 4.9303804986079074, 5.1349925953115969, 5.343154241175319, 5.5739314485861904, 5.820995669089827, 6.0693229130231439, 6.3152405588258249, 6.5497272260477999, 6.7890446546182632, 7.0252472402907706, 7.2593409163450735, 7.4947941821366433, 7.7241778909644188, 7.9569410959073918, 8.1983955011000802, 8.4286264274833567, 8.6658386366725129, 8.8940739306884762, 9.1214671910622833, 9.3380304210278027, 9.5450458069467832, 9.7520409220153006, 9.9593172799343126, 10.100472263783605, 10.061310570316097, 9.8068153404225455, 9.4931769478416186, 9.1531472400072147, 8.8231039678230925, 8.4944093497119937, 8.1707524854278706, 7.8456549792563717, 7.5079428516283251, 7.169088944995984, 6.8292642550933156, 6.4833707296764338, 6.1056603511855272, 5.7097472179550612, 5.3743472375480126, 5.100721940172332, 4.8582529048621961, 4.6456738278272294, 4.4203025662515438, 4.1945613990024615, 3.9737382520267253, 3.7572834798431578, 3.5499376385807988, 3.3378768991181889, 3.11604696316618, 2.8780259321554498, 2.636473628285275, 2.3999346592863038, 2.1647648645735598, 1.9389352717067445, 1.713227749979646, 1.490929732113726, 1.2654650087096682, 1.0273339234975689, 0.78183895969569495, 0.53531085860905603, 0.31712382400008005, 0.095942397995614007, -0.14079177676856267, -0.38657378546973209, -0.63585866261010182, -0.87222742054208779, -1.1077114500526779, -1.33958174561376, -1.5727083587941053, -1.812532456726329, -2.0484495053317118, -2.2872451882803091, -2.5259539151345018, -2.7607643705361173, -3.0035352381653011, -3.2385014667457925, -3.4734017625789781, -3.7154619273617921, -3.9586753227189502, -4.2000003935198267, -4.43541700152484, -4.6630000659200705, -4.889956966605058, -5.1108828820222483, -5.3350483097428425, -5.5474110748373793, -5.7499625021779401, -5.9490975244395319, -6.1448882738627937, -6.3570107122543513, -6.5714694116019583, -6.7538349170229193, -6.8280466752527369, -6.8178607746263244, -6.6818733953671519, -6.4739462467128162, -6.2023183889180507, -5.8949408293483589, -5.5769693316725251, -5.2637251352628418, -4.9407592437433268, -4.6162229345651555, -4.2873471834389054, -3.9542932140258165, -3.6081914690783026, -3.2237649764044907, -2.827483832174372, -2.4624316198180192, -2.162198868635627, -1.8873724956341977, -1.6144416087095832, -1.3552424399908669, -1.1123141580444924, -0.86790742858136505, -0.6384418825060505, -0.4032885221541378, -0.17010355813884101, 0.057826253166703846, 0.27535901383809602]
# traj_y =  [-2.9267062403800002, -2.5951577866933073, -2.2555137887595209, -1.9167923443005552, -1.573065306770876, -1.2375483880247167, -0.90526161507239278, -0.56991837377249566, -0.25375190014768134, 0.069129414999055602, 0.39468542478746937, 0.72544756659928167, 1.0634419380889937, 1.4056342037599125, 1.7485335269822935, 2.084302355025891, 2.4164525567438662, 2.7368129739652307, 3.0662016676266832, 3.408232495177689, 3.7515720911471306, 4.0952821149968957, 4.4368344147538084, 4.7635225202918248, 5.0781189971052285, 5.391711843962641, 5.7071083003319441, 6.031215131225526, 6.3517281206901979, 6.6745148631823543, 6.9988549314423461, 7.3222223295205824, 7.6499089312615789, 7.975207376013107, 8.2941305245715533, 8.6212147769265695, 8.9432785794551215, 9.2717730672557881, 9.6008762904009366, 9.9370927690451865, 10.279366029475124, 10.621585408929942, 10.96369806700195, 11.336987086516137, 11.729851114582898, 12.037434716113962, 12.284623281834802, 12.495391819854914, 12.721368323773021, 12.949317040473112, 13.184341893742017, 13.417320426302373, 13.631717397441809, 13.84417298054953, 14.055021356024316, 14.25578692911076, 14.386443743014716, 14.372122815928119, 14.161035485040866, 13.868755851205322, 13.551409198793747, 13.212463746041843, 12.881981144518733, 12.551842787462739, 12.218274552328818, 11.881965127947698, 11.539861269780451, 11.200740082027091, 10.867807732034889, 10.546429250457928, 10.227596968894302, 9.9050271588477674, 9.5814416439445047, 9.2513126085345423, 8.9210801211356952, 8.5885459928904933, 8.2583118967982774, 7.9367881223404364, 7.6209975759603994, 7.3062870370859976, 6.9708047879204669, 6.6375709042982187, 6.3151362726107241, 5.9995564283338432, 5.68668876169599, 5.3640702530838613, 5.0406977416315728, 4.7147818698355461, 4.3897915712157864, 4.0696359924075898, 3.746612875921401, 3.425710929387678, 3.1047592324096533, 2.7809515741484172, 2.4630430293943273, 2.139314397022742, 1.8155578978459934, 1.4971120933227171, 1.1795459346569357, 0.86054483472265209, 0.53715069714125407, 0.20821357977259397, -0.12118510079530535, -0.45460847605563193, -0.78595736627436064, -1.1247618008236664, -1.4697765908667226, -1.8166353291615334, -2.1654833705195937, -2.504617024377469, -2.842073717015003, -3.1977967158624083, -3.5915864208756663, -3.9892804453979487, -4.3671625924409643, -4.7077234360058933, -5.0019971420852904, -5.2576667823711833, -5.50035177214263, -5.7490913388986762, -5.9851087376965317, -6.2189619427410099, -6.4465528950401918, -6.6681090879680545, -6.8685530484685557, -6.9739007047398527, -6.925562550158026, -6.7623666270415805, -6.4984973445403611, -6.2080463958222305, -5.9157464216980298, -5.6109371630737677, -5.2932613856500499, -4.9766482281797755, -4.6489759720222237, -4.3254125003092048, -4.0003697047894189, -3.6717492024444853, -3.3360290634512522]
# traj_x = traj_x[::-1]
# traj_y = traj_y[::-1]
# traj_x = [-0.212822934793, -0.212898920745, -0.213009170353, -0.213169870238, -0.213074540097, -0.213109566356, -0.213099328734, -0.213172409473, -0.213282882968, -0.213343725174, -0.213280121986, -0.213307983956, -0.213343450051, -0.213323724905, -0.213369132933, -0.213599641151, -0.213635737573, -0.213554575689, -0.213714574413, -0.213793860152, -0.213903818072, -0.213986407328, -0.212155045485, -0.200519333859, -0.128209035839, -0.00909045574095, 0.121391656804, 0.248876450376, 0.351461631497, 0.449195354695, 0.531642109716, 0.610323547263, 0.640884842522, 0.684553454663, 0.726823516248, 0.75535541017, 0.740602811479, 0.659877256361, 0.579951870542, 0.532926853181, 0.499833307231, 0.505113700529, 0.530767953442, 0.576552535154, 0.63848492427, 0.72654382148, 0.844227496109, 0.918120325219, 0.922885817071, 0.924557605021, 0.922463761216, 0.877414301513, 0.762325246978, 0.558679815071, 0.285928263256, -0.00147554862399, -0.305911714857, -0.589158762813, -0.83368842013, -1.09338284044, -1.34550521001, -1.56683260362, -1.77963957029, -2.0078947474, -2.21245731475, -2.40545888496, -2.60877675227, -2.79168768821, -3.00164501678, -3.20681949326, -3.4244290711, -3.61907545065, -3.81613934661, -4.02660116849, -4.22250316775, -4.40439848706, -4.59517220944, -4.79642862628, -5.00832256107, -5.22226618465, -5.41304127398, -5.58459184268, -5.75041631234, -5.9294858024, -6.11515697244, -6.29159878369, -6.44432471237, -6.5515309703, -6.59792801075, -6.56847562018, -6.45126609363, -6.23697366806, -5.96869815865, -5.65125066993, -5.387965902, -5.13185650503, -4.85741364192, -4.59594463783, -4.32407668324, -4.06883613492, -3.79534897685, -3.51188917419, -3.25572664964, -2.97918230861, -2.69233223133, -2.38848066961, -2.08538870904, -1.81913189037, -1.57761621589, -1.31414377143, -1.06537004398, -0.8334497635, -0.612054456984, -0.397578447836, -0.166053812271, 0.0626967807201, 0.264160589415, 0.445424931991, 0.623946301211, 0.820061995221, 0.997025151249, 1.21133628683, 1.43284637039, 1.64186601771, 1.84003341205, 2.02857655458, 2.19266827125, 2.35656861001, 2.46782158496, 2.5630462034, 2.62407818719, 2.63923509587, 2.57921224639, 2.43937558825, 2.32145832294, 2.21729123597, 2.10320044984, 2.01327848784, 1.92092042711, 1.84289476539, 1.77389469393, 1.70191928346, 1.62386527132, 1.5836269441, 1.5879805348, 1.62804249771, 1.77966650224, 1.992693442, 2.2337372957, 2.45488076762, 2.68928752868, 2.94090622004, 3.23324010711, 3.49385165591, 3.72561061785, 3.92886629517, 4.11953104799, 4.31185443711, 4.51622555447, 4.67165605469, 4.81240012422, 4.92281407543, 5.023065782, 5.1351909744, 5.26534868873, 5.40155879747, 5.548823131, 5.69583361029, 5.86773731905, 6.04144926806, 6.22893177076, 6.46072849013, 6.71807816015, 6.9850206866, 7.23808181121, 7.50117791562, 7.75292973008, 7.98275468267, 8.18379691324, 8.4196082322, 8.65637667251, 8.88078159993, 9.08428918646, 9.28692746692, 9.49912997746, 9.61823773133, 9.65595769593, 9.58592858235, 9.45790518518, 9.27722504702, 9.11678462238, 8.96248551934, 8.79714752377, 8.62281338019, 8.44157573322, 8.26723602141, 8.06047106656, 7.80613849677, 7.54701555671, 7.26476774494, 7.04455475635, 6.68302816006, 6.2760407888, 5.71653117347, 5.09094607283, 4.5062179606, 3.97910846605, 3.60793307305, 3.43121484534, 3.42107944715, 3.42050829664, 3.42047459546, 3.42166636444, 3.42331480054, 3.42197935693, 3.42442709868, 3.42512928597, 3.42450675822, 3.42465641524, 3.42316445169, 3.4243867848, 3.42213382548, 3.41992923391, 3.4187362542, 3.41854513078, 3.41702226921]
# traj_y = [-3.54833023529, -3.54818545992, -3.54811284336, -3.54817823833, -3.54802457317, -3.54779681783, -3.5477507919, -3.54742971932, -3.54736039182, -3.54715590926, -3.54692267673, -3.54645918126, -3.54640471109, -3.54618342207, -3.54608157158, -3.5460321222, -3.54595863095, -3.54579879381, -3.54562991031, -3.54546797828, -3.54537450399, -3.54529398872, -3.54319192774, -3.52851410035, -3.43083572323, -3.25223200066, -3.05112332311, -2.82781526311, -2.59629062968, -2.35378673848, -2.1254349953, -1.89166622171, -1.65575977752, -1.39728265863, -1.10163586152, -0.759803365122, -0.397820596746, -0.0450769777309, 0.266826849535, 0.606537709371, 0.966233666702, 1.31121072996, 1.66290442098, 2.01651072306, 2.35391064762, 2.70062566396, 3.05528506823, 3.3530901662, 3.67895448937, 4.03492825644, 4.35807225022, 4.67949309961, 4.9736838395, 5.1989885211, 5.36403637096, 5.43879995582, 5.41503337917, 5.30335164493, 5.1075587278, 4.90213766062, 4.71249268377, 4.48614632911, 4.20653669617, 3.9025789197, 3.63799790342, 3.38136972474, 3.10428960946, 2.83588569704, 2.54410753519, 2.27143625379, 1.98280285211, 1.70951372524, 1.45647273084, 1.17618277486, 0.904260352442, 0.626237909323, 0.356589194416, 0.0753010632771, -0.213510172848, -0.503125656284, -0.778998092669, -1.03112662814, -1.30573281944, -1.59620184837, -1.89879557568, -2.18907424418, -2.47753712026, -2.78375762498, -3.08740480795, -3.39018015523, -3.67097859285, -3.8863979814, -4.04982076044, -4.25208797837, -4.46951292205, -4.65772377088, -4.86352896493, -5.06144776518, -5.26233594759, -5.46773145921, -5.68799741563, -5.90369067722, -6.11951735406, -6.30640594947, -6.42528227747, -6.45267678286, -6.41417281134, -6.30021498725, -6.11697309142, -5.89539625108, -5.67380777989, -5.43789989297, -5.19663474822, -4.94125896301, -4.68306900196, -4.42660307485, -4.16337574388, -3.91167295065, -3.63057471792, -3.32419059655, -3.07305035385, -2.75527176613, -2.43478713807, -2.10852658337, -1.76725100683, -1.3885846295, -0.984809583506, -0.574921133165, -0.189150044982, 0.24702937931, 0.712860473722, 1.19515351078, 1.67767794424, 2.17327112202, 2.68955469674, 3.18377348962, 3.66045027438, 4.13591559696, 4.63100702878, 5.11746965453, 5.62058031935, 6.10046383962, 6.59313270412, 7.10729042516, 7.6000833606, 8.09413440035, 8.56144072692, 9.01844548696, 9.4511875886, 9.88314252205, 10.3094234994, 10.7085237879, 11.1175414989, 11.4755319969, 11.8050563108, 12.0725100446, 12.3400394069, 12.5925472008, 12.86121691, 13.0787272784, 13.2692948903, 13.4217798864, 13.5560851359, 13.7120443231, 13.871383049, 14.0175962104, 14.1155078855, 14.1628708757, 14.1449686628, 14.1041777604, 13.9984704002, 13.8709333809, 13.7423248404, 13.6024185656, 13.4796417768, 13.3407657478, 13.2084224197, 13.0711341347, 12.9512045518, 12.7954924397, 12.6363589553, 12.4565271696, 12.290468534, 12.1172126793, 11.9291906773, 11.7401274174, 11.5169442709, 11.247092108, 10.9293556706, 10.5959419981, 10.278043026, 9.94520014545, 9.63441808314, 9.31097433486, 8.96968496466, 8.62485923945, 8.23785160989, 7.81732946418, 7.39333815623, 6.97114385353, 6.61443113098, 6.0785702665, 5.41437341479, 4.61750328347, 3.81401519132, 3.01061395531, 2.40155033492, 1.96323871436, 1.74383783601, 1.73756820567, 1.74482277473, 1.75223812886, 1.75820354203, 1.75778849776, 1.75565441092, 1.75507364774, 1.75350220103, 1.75058304584, 1.74819815946, 1.74512401294, 1.74128426012, 1.73628880022, 1.73100373934, 1.72731893016, 1.72385113345, 1.71973963231]

xs = [14.47, 37.26]
ys = [1.60, 1.29]
traj_x = np.linspace(xs[0], xs[1]).tolist()
traj_y = np.linspace(ys[0], ys[1]).tolist()
xs = [37.26,37.35]
ys = [1.29,6.96]
traj_x = np.append(traj_x,np.linspace(xs[0], xs[1]).tolist()[1:])
traj_y = np.append(traj_y,np.linspace(ys[0], ys[1]).tolist()[1:])
xs = [37.35,14.68]
ys = [6.96,7.31]
traj_x = np.append(traj_x,np.linspace(xs[0], xs[1]).tolist()[1:])
traj_y = np.append(traj_y,np.linspace(ys[0], ys[1]).tolist()[1:])
xs = [14.69,14.47]
ys = [7.31,1.60]
traj_x = np.append(traj_x,np.linspace(xs[0], xs[1]).tolist()[1:-1])
traj_y = np.append(traj_y,np.linspace(ys[0], ys[1]).tolist()[1:-1])

###############################################################################

## INIT #######################################################################
default_init_pt = [0.0, 0.0, 0.0, 0.0] # [x, y, yaw, v], units: [m, m, rad, m/s]
###############################################################################


def param_init():
    """Initialization handles use with just python or in a launch file
    """
    # grab parameters from launch-file
    start_pt_param = rospy.search_param('start_pt')
    is_sim_param = rospy.search_param('is_sim')
    use_rviz_param = rospy.search_param('use_rviz')
    use_matplotlib_param = rospy.search_param('use_matplotlib')
    run_lidar_param = rospy.search_param('run_lidar')

    start_pt = rospy.get_param(start_pt_param, default_init_pt)
    if isinstance(start_pt, str):
        start_pt = start_pt.split(',')
        start_pt = [float(curr) for curr in start_pt]
        start_pt = VehicleState(*start_pt)

    is_sim = rospy.get_param(is_sim_param, True)
    use_rviz = rospy.get_param(use_rviz_param, False)
    use_matplotlib = rospy.get_param(use_matplotlib_param, False)
    run_lidar = rospy.get_param(run_lidar_param, True)

    return start_pt, is_sim, use_rviz, use_matplotlib, run_lidar

def callback_scan(scan):
    """ Callback for lidarscan """
    ranges = scan.ranges
    min_dist = np.nanmin(ranges) # TODO: Make available as self.min_dist etc.?

def main():
    rospy.init_node('floor2_team1')
    start_pt, is_sim, use_rviz, use_matplotlib, _run_lidar = param_init()

    # select data handler based on the ros params
    if use_rviz:
        DataHandler = RVIZPathHandler
    elif use_matplotlib:
        DataHandler = TrajDataHandler
    else:
        DataHandler = BasicDataHandler

    if is_sim:
        # start the simulation
        model_for_sim = SimpleBicycleModel(start_pt)
        simulator = SimSVEA(vehicle_name, model_for_sim,
                            dt=dt, start_paused=True, run_lidar=_run_lidar).start()

    lidar_sub = rospy.Subscriber("/scan", LaserScan, callback_scan)

    # start pure pursuit SVEA manager
    svea = SVEAMPC(
        vehicle_name,
        LocalizationInterface,
        MPC,
        traj_x, traj_y,
        data_handler = DataHandler,
        target_velocity=params.target_velocity,
        dl = dt*params.low_lim,
        low_lim = params.low_lim,
    )

    ulb = [-1e2,-np.deg2rad(40)]
    uub = [ 1e2, np.deg2rad(40)]
    xlb = [-np.inf]*3+[-1]
    xub = [ np.inf]*3+[3.6]

    svea.controller.build_solver(
        dt,
        Q=params.Q,
        R=params.R,
        P=params.P,
        ulb=ulb,
        uub=uub,
        xlb=xlb,
        xub=xub,
        max_cpu_time=0.8*dt,
        horizon=params.horizon,
        model_type=params.model_type,
        solver_=params.solver_,
        TAU = params.TAU,
        N_IND_SEARCH = params.N_IND_SEARCH,
    )
    svea.start(wait=True)

    if is_sim:
        # start simulation
        simulator.toggle_pause_simulation()

    # simulation loop
    svea.controller.target_velocity = target_velocity
    while not svea.is_finished and not rospy.is_shutdown():
        state = svea.wait_for_state()

        # compute control input via pure pursuit
        steering, velocity = svea.compute_control()
        #print("velocity = ", velocity, "steering = ", steering)
        svea.send_control(steering, velocity)

        # visualize data
        if use_matplotlib or use_rviz:
            svea.visualize_data()
        else:
            rospy.loginfo_throttle(1, state)

    if not rospy.is_shutdown():
        rospy.loginfo("Trajectory finished!")

    rospy.spin()


if __name__ == '__main__':
    main()
